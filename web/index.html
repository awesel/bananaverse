<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BananaVerse</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçå</text></svg>"
    />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        background: #0b0c10;
        color: #eaeaea;
      }
      header {
        background: #1f2833;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
      }
      h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.5px;
      }
      .container {
        padding: 16px 24px;
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 24px;
      }
      textarea {
        width: 100%;
        min-height: 200px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #3a4750;
        background: #0f1115;
        color: #eaeaea;
        font-family: inherit;
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
        box-sizing: border-box;
      }
      button {
        background: #66fcf1;
        border: none;
        color: #0b0c10;
        font-weight: 700;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      button:hover:not(:disabled) {
        background: #45b7b8;
        transform: translateY(-1px);
      }
      button:disabled {
        background: #2b7a78;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .generating {
        background: #f39c12 !important;
        color: #ffffff !important;
        transform: none !important;
      }
      .generating:hover {
        background: #f39c12 !important;
        transform: none !important;
      }
      .panel {
        background: #0f1115;
        border: 1px solid #3a4750;
        border-radius: 12px;
        padding: 16px;
      }
      .panel h3 {
        margin-top: 0;
        margin-bottom: 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        margin-top: 8px;
      }
      .status {
        font-size: 12px;
        color: #9aa5b1;
      }
      .assets {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 16px;
      }
      select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        background: #0f1115;
        color: #eaeaea;
        border: 1px solid #3a4750;
        font-size: 14px;
        box-sizing: border-box;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 600;
        color: #c9d1d9;
      }
      img {
        max-width: 100%;
        border-radius: 8px;
        background: #121419;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }
      .thumb {
        background: #0b0c10;
        border: 1px solid #3a4750;
        border-radius: 8px;
        padding: 8px;
      }
      .thumb img {
        width: 100%;
        display: block;
      }
      .final {
        background: #0f1115;
        border: 1px solid #3a4750;
        border-radius: 12px;
        padding: 16px;
      }
      .final h3 {
        margin-top: 0;
        margin-bottom: 16px;
      }
      .hidden {
        display: none;
      }
      .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>BananaVerse</h1>
      <div class="status" id="status">Idle</div>
    </header>
    <div class="container">
      <div class="panel">
        <h3>Enter Story</h3>
        <textarea
          id="story"
          placeholder="Paste or write your story here..."
        ></textarea>
        <div class="row">
          <button id="startBtn">Generate</button>
          <span class="status" id="runInfo"></span>
        </div>
        <div class="status code" id="log"></div>
        <div class="assets">
          <div>
            <label>Characters</label>
            <select id="charSelect"></select>
            <div id="charView" class="thumb hidden"></div>
          </div>
          <div>
            <label>Scenes</label>
            <select id="sceneSelect"></select>
            <div id="sceneView" class="thumb hidden"></div>
          </div>
        </div>
      </div>
      <div>
        <div class="final">
          <h3>Combined Output</h3>
          <img id="finalImg" alt="final" />
          <div class="grid" id="panelsGrid"></div>
        </div>
      </div>
    </div>
    <script>
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const runInfoEl = document.getElementById("runInfo");
      const startBtn = document.getElementById("startBtn");
      const storyEl = document.getElementById("story");
      const finalImg = document.getElementById("finalImg");
      const panelsGrid = document.getElementById("panelsGrid");
      const charSelect = document.getElementById("charSelect");
      const sceneSelect = document.getElementById("sceneSelect");
      const charView = document.getElementById("charView");
      const sceneView = document.getElementById("sceneView");

      let currentRun = null;
      let manifest = null;

      function log(line) {
        logEl.textContent += `\n${line}`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      function toURL(path) {
        return `/api/file?run=${encodeURIComponent(
          currentRun
        )}&path=${encodeURIComponent(path)}`;
      }

      function renderAssets() {
        if (!manifest) return;
        // Characters
        charSelect.innerHTML = "";
        if (manifest.characters && manifest.characters.length) {
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "‚Äî select ‚Äî";
          charSelect.appendChild(opt0);
          for (const c of manifest.characters) {
            const opt = document.createElement("option");
            opt.value = c.file;
            opt.textContent = c.name;
            charSelect.appendChild(opt);
          }
        }
        // Scenes
        sceneSelect.innerHTML = "";
        if (manifest.scenes && manifest.scenes.length) {
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = "‚Äî select ‚Äî";
          sceneSelect.appendChild(opt0);
          for (const s of manifest.scenes) {
            const opt = document.createElement("option");
            opt.value = s.file;
            opt.textContent = s.name;
            sceneSelect.appendChild(opt);
          }
        }
      }

      function renderPanels() {
        if (!manifest || !manifest.panels) return;
        panelsGrid.innerHTML = "";
        for (const p of manifest.panels) {
          const div = document.createElement("div");
          div.className = "thumb";
          const img = document.createElement("img");
          img.src = toURL(p.file) + "&_ts=" + Date.now();
          const cap = document.createElement("div");
          cap.className = "status";
          cap.textContent = `#${p.index}`;
          div.appendChild(img);
          div.appendChild(cap);
          panelsGrid.appendChild(div);
        }
      }

      function refreshFinal() {
        finalImg.src = toURL("comic_final.png") + "&_ts=" + Date.now();
      }

      async function fetchManifest() {
        if (!currentRun) return;
        try {
          const r = await fetch(
            `/api/manifest?run=${encodeURIComponent(currentRun)}`
          );
          const j = await r.json();
          if (j && Object.keys(j).length) {
            manifest = j;
            renderAssets();
            renderPanels();
          }
        } catch (e) {
          // ignore
        }
      }

      function startStream() {
        const es = new EventSource("/api/stream");
        es.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.type === "start") {
              statusEl.textContent = "...";
              log("Run started");
            } else if (data.type === "progress") {
              if (data.files && data.files.length) {
                log("Files: " + data.files.join(", "));
                fetchManifest();
                // Re-render panels after each update to show new panels immediately
                setTimeout(renderPanels, 100);
              }
              if (data.final) {
                refreshFinal();
              }
            } else if (data.type === "assets") {
              // Minimal assets update before manifest
              if (!manifest)
                manifest = { characters: [], scenes: [], panels: [] };
              if (Array.isArray(data.characters)) {
                manifest.characters = data.characters;
              }
              if (Array.isArray(data.scenes)) {
                manifest.scenes = data.scenes;
              }
              renderAssets();
            } else if (data.type === "manifest") {
              manifest = data.manifest;
              renderAssets();
              renderPanels();
            } else if (data.type === "done") {
              statusEl.textContent = "Completed";
              refreshFinal();
              startBtn.disabled = false;
              startBtn.textContent = "Generate";
              startBtn.classList.remove("generating");
              es.close();
            } else if (data.type === "error") {
              statusEl.textContent = "Error";
              log("Error: " + data.message);
              startBtn.disabled = false;
              startBtn.textContent = "Generate";
              startBtn.classList.remove("generating");
              es.close();
            }
          } catch (err) {
            // ignore malformed lines
          }
        };
        es.onerror = () => {
          es.close();
        };
      }

      startBtn.addEventListener("click", async () => {
        const story = storyEl.value.trim();
        if (!story) return;
        startBtn.disabled = true;
        startBtn.textContent = "Generating...";
        startBtn.classList.add("generating");
        statusEl.textContent = "...";
        logEl.textContent = "";
        finalImg.removeAttribute("src");
        panelsGrid.innerHTML = "";
        charSelect.innerHTML = "";
        sceneSelect.innerHTML = "";
        charView.classList.add("hidden");
        sceneView.classList.add("hidden");
        manifest = null;
        try {
          const r = await fetch("/api/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ story }),
          });
          const j = await r.json();
          if (j.run) {
            currentRun = j.run;
            runInfoEl.textContent = currentRun;
            startStream();
          } else {
            statusEl.textContent = "Failed to start";
          }
        } catch (e) {
          statusEl.textContent = "Failed to start";
          startBtn.disabled = false;
          startBtn.textContent = "Generate";
          startBtn.classList.remove("generating");
        }
      });

      charSelect.addEventListener("change", () => {
        const path = charSelect.value;
        if (!path) {
          charView.classList.add("hidden");
          return;
        }
        charView.innerHTML = `<img src="${toURL(path)}&_ts=${Date.now()}" />`;
        charView.classList.remove("hidden");
      });

      sceneSelect.addEventListener("change", () => {
        const path = sceneSelect.value;
        if (!path) {
          sceneView.classList.add("hidden");
          return;
        }
        sceneView.innerHTML = `<img src="${toURL(path)}&_ts=${Date.now()}" />`;
        sceneView.classList.remove("hidden");
      });
    </script>
  </body>
</html>
